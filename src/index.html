<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="Shift-JIS">
	<title>DisNOTE - マルチトラック動画_トラック1に全部の音_disnote</title>
	<link href="htmlfiles/main.css" rel="stylesheet">
	<link href="htmlfiles/jquery-ui.css" rel="stylesheet">
	<script src="htmlfiles/jquery-3.6.0.min.js"></script>
	<script src="htmlfiles/jquery.floatThead.min.js"></script>
	<script src="htmlfiles/jquery-ui.min.js"></script>

	<script>
	$(function() {

		// 話者
		var people = {};
		
		var textBase = 5; // resultの配列の中で本文がある場所
		
		$toptr = $($('#table').find('tr')[0]);
		var toptr_top = $toptr.offset().top; // 先頭tr（thead）の表示位置
		
		// 指定した<tr>が上の端に来るようにスクロール
		function scrollToTop($target, force){
			if(!$target){
				return;
			}
			var y = $target.offset().top - toptr_top;
			if(force || y < $(window).scrollTop()){
				$(window).scrollTop(y);
			}
		}

		// 指定した<tr>が下の端に表示されるようにスクロール
		function scrollToBottom($target, force){
			var y = $target.offset().top + $target.height() + $("#foottable").height() + 35;
			if(force || ($(window).scrollTop() +  $(window).height() < y)){
				$(window).scrollTop(y - $(window).height());
			}
		}

		// 話者表示切替
		function updateShowNameMode(){
			$("th.name").css("display", $('#showname').prop('checked') ? "table-cell" : "none");
			$("td.name").css("display", $('#showname').prop('checked') ? "table-cell" : "none");
		}
		$("#showname").change(function(){
			updateShowNameMode();
			saveConfig();
		});

		// 行の表示/非表示切り替え(特定話者)
		function updatePersonLineDisplay($person){
			var id = $person.attr("id");
			
			if($person.val() != "false"){ // 話者チェック
				if($('#notext').prop('checked')){ // 「認識できなかった行を表示」チェック
					$(".textexists."+id).css("display", "table-row");
					$(".notext."+id).css("display", "table-row");
				}else{ //「認識できなかった行を表示」チェックされてない ⇒ 特定の話者 and notextでない行だけ表示
					$(".textexists."+id).css("display", "table-row");
					$(".notext."+id).css("display", "none");
				}
			}else{ // 話者非表示
				$(".textexists."+id).css("display", "none");
				$(".notext."+id).css("display", "none");
			}
		}
		
		// 行の表示/非表示切り替え
		function updateLineDisplay(){
			$prevtr = undefined;
			$toptr = undefined;
			
			// いま画面の一番上に表示されているtrを探す（このtrが画面の一番上に表示されるようにスクロール位置を調整する）
			$('#table').find('tr').each( function( index, element ){
				if(!($(element).css('display') == "none")){ // $(element).hasClass("notext")
					var t = $(element).offset().top -  $(window).scrollTop();
					if(t > toptr_top){
						$toptr = $prevtr;
						return false;
					}
					$prevtr = $(element);
				}
			});
			
			var show = 0;
			var total = 0;
			// 話者ごとの表示/非表示設定
			$(".person_input").each( function( index, element ){
				updatePersonLineDisplay($(element));
				total++;
				if($(element).val()!= "false"){ show++;}
			});
			$("#peoplecount").text("(" + show + "/" + total + ")");
			

			// 元のtrを先頭に表示するようにスクロール位置を調整
			scrollToTop($toptr, true);
			
			// 再検索
			search(true);

			if($("#peoplelist").dialog("isOpen")){ // スクロールで話者選択ウィンドウが遠くに行ってしまうことがあるので再表示
				$("#peoplelist").dialog( "close" );
				$("#peoplelist").dialog("open");
			}
		
		}

		// 認識できなかった行を表示
		$("#notext").change(function(){
			updateLineDisplay();
			saveConfig();
		});

		// 時刻切り替え
		function updateTimeMode(){
			if($('#abstime').prop('checked')){
				$(".abstime").css("display", "inline");
				$(".reltime").css("display", "none");
			}else{
				$(".reltime").css("display", "inline");
				$(".abstime").css("display", "none");
			}
		}
		$("#abstime").change(function(){
			updateTimeMode();
			saveConfig();
		});
		
		// 自動再生切り替え（設定保存のみ）
		$("#autoplay").change(function(){
			saveConfig();
		});
		
		// 行内の表示する候補を変更
		function changeText($td, d){
			changeCurrentTd($td);
			$target = $td.parent().data('textTd');

			var current = 0 + $target.data('current');
			var len = 0 + $target.data('textlen');
			if(len <= 0){
				return;
			}
			current = (len + current + d) % len;

			$target.data('current', current);
			$target.text($target.data('text' + current));
			
			var title = (current + 1) + "/" + len;
			var textId = $target.attr('id');
			$("#" + textId + "_l").attr({"title": title });
			$("#" + textId + "_r").attr({"title": title });
			
			var number = $td.data('number');
			selection[number] = String(Number.isInteger(current) ? current : 0);
			saveProjectSelection();
		}
		
		// ミリ秒から時間表記に変換
		function getTimeStr(base, t){
			date = new Date(base.getTime() + t);
			d = ('0' + date.getHours()).slice(-2) + ":" + ('0' + date.getMinutes()).slice(-2) + ":" + ('0' + date.getSeconds()).slice(-2);
			return d;
		}
		
		// 現在選択されている行
		$currentTd = undefined;
		
		// $tdを選択
		function changeCurrentTd($td, seekOrgMedia = true){
			$(".current").removeClass('current');
			if(!$td){		return;			}
			
			$td = $td.parent().data('playTd');
			if(!$td){		return;			}
			
			$currentTd = $td;
			
			// 再生中の行に色付け
			if($currentTd ){
				$currentTd.parent().addClass('current');
				console.log(0 + $currentTd.parent().data('time'));
				
				if(seekOrgMedia){
					$("#orgmedia")[0].currentTime = $currentTd.parent().data('time');
					$("#movie")[0].currentTime = $currentTd.parent().data('time');
				}
			}
		}
		
		// 次の行へ(d=1),前の行へ(d=-1)
		function nextTd($td, d){
			if(!$td){	return;}
			var next_id = $td.data('number'); // 最後の空白時間を飛ばしたいが難しいか
			$nextPlayTd = null;
			
			do{ // 次の行を探す（非表示の場合はスキップ）
				next_id += d;
				$nextPlayTd = $("#play_" + next_id);
				
				if($nextPlayTd.length <= 0){	return null;} // 最後まで進んだ
				
			}while($nextPlayTd.parent().css('display') == "none")
			
			return $nextPlayTd;
		
		}
		
		// 音声再生
		function play($td){
			changeCurrentTd($td);

			// ファイル名設定
			$("#sound").attr({"src": $td.data('filename') });
			// 再生
			$("#sound")[0].play();
		}
		
		// 再生終了
		$("#sound").on("ended", function(){
			if($('#autoplay').prop('checked')){ // 連続再生
				$currentTd = nextTd($currentTd, +1); // 次の行へ

				// 次の行を再生
				if($currentTd){
					play($currentTd);
		
					// 画面外に出ていた場合はスクロール
					scrollToBottom($nextPlayTd, false);
				}
			}
		});
		
		// 2つの音声を同時に再生できないようにする
		$("#orgmedia").on("play", function(){
			$("#sound")[0].pause();
			$("#movie")[0].pause();
		});
		$("#sound").on("play", function(){
			$("#orgmedia")[0].pause();
			$("#movie")[0].pause();
		});
		$("#movie").on("play", function(){
			$("#orgmedia")[0].pause();
			$("#sound")[0].pause();
		});
		
		// オリジナル音源の時間が動いたときに、currentTdを移動する
		function changeCurrentTdByMedia($m){
			var t = $m[0].currentTime;
			if(mixedMediaIsMovie){
				$("#movieThumbnail")[0].currentTime = t; // 動画のサムネイルを追いつかせる
			}
			
			defaultCurrentTd();
			var currentT = $currentTd.parent().data('time');
			
			$targettd = undefined;
			if(currentT < t){ // オリジナル音源にcurrentTdを追いつかせる
				$targettd = $currentTd;
				do{
					$tmptd = nextTd($targettd,1);
					if(!$tmptd){
						break;
					}
					if($tmptd.parent().data('time') > t){ // 追い抜く直前まで進める
						break;
					}
					$targettd = $tmptd;
				}while($targettd);
			}else{ // オリジナル音源までcurrentTdを戻す
				$targettd = $currentTd;
				while($targettd){
					if($targettd.parent().data('time') <= t){ // オリジナル音源の前まで戻る
						break;
					}
					$targettd = nextTd($targettd,-1);
				}
			}
			
			if($targettd && $targettd != $currentTd){ // currentTd移動（0の移動をさせるとそこからまたイベントが走るのでそれを防ぐ）
				changeCurrentTd($targettd, false); // シークしない
				scrollToTop($currentTd, false);
				scrollToBottom($currentTd, false);
			}
		}
		$("#orgmedia").on("timeupdate ", function(){
			changeCurrentTdByMedia($("#orgmedia"))
		});
		$("#movie").on("timeupdate ", function(){
			changeCurrentTdByMedia($("#movie"))
		});
		
		// ウィンドウスクロール時、ダイアログの位置を追随させる
		$(window).on('scroll', function() {
			[$("#movieDialogue"), $("#help"), $("#peoplelist") ].forEach(function($t){
				$p = $t.parent();
				if($p.css('display') != 'none') {
					var top = $(window).scrollTop() + $p.data('objectTop');
					$p.offset({ top: top});
				}
			});
		}).trigger('scroll');
		
		// ダイアログの位置を覚える（ウィンドウがスクロールしたときに追随するため）
		function saveDialoguePos($t){
			$p = $t.parent();
			var top = $p.offset().top  - $(window).scrollTop();
			$p.data('objectTop',top);
		}
		
		// 動画サムネイルクリックで動画ダイアログを開く
		$("#movieThumbnail").on("click", function(){
			$("#movieDialogue").dialog("open");
			$("#orgmedia")[0].pause();
			$("#orgmedia").css("display", "none"); // audioとサムネは隠す
			$("#movieThumbnail").css("display", "none");
		});
		$("#movieDialogue").dialog({ // 動画ダイアログ
			autoOpen: false, width:"400",
			closeOnEscape:true ,
			position: {my: "right", at: "right"},
			collision: "flipfit",
			resize: function() {
				$(this).css("overflow", "hidden"); // リサイズ時のスクロールバー消し
			},
			open: function() {					saveDialoguePos($(this));		},
			resizeStop: function() {		saveDialoguePos($(this));		},
			dragStop: function() {			saveDialoguePos($(this));		},
		});
		
		$("#movieDialogue").on("dialogclose", function(){
			$("#orgmedia").css("display", "inline");
			$("#movieThumbnail").css("display", "inline");
			$("#movie")[0].pause();
		});

		// ヘルプダイアログ設定
		$("#help").dialog({
			autoOpen: false,
			modal: true ,
			title:"ショートカットキー", closeOnEscape:true,
			width:"630",
			open: function() {					saveDialoguePos($(this));		},
			resizeStop: function() {		saveDialoguePos($(this));		},
			dragStop: function() {			saveDialoguePos($(this));		},
		});
		$( "#open_help" ).click(function() {
			$("#help").dialog("open");
		}); 
		$("#close_help").on("click", function(){
			$("#help").dialog( "close" );
		});

		// 話者表示切替ダイアログ設定
		$("#peoplelist").dialog({
			autoOpen: false,
			modal: true ,
			title:"話者設定",
			closeOnEscape:true,
			close: function(event, ui){ // ダイアログを閉じるときに表示非表示と話者名を変更
				for (key in personalData){
					var pv = personalData[key];
					// 名前変更
					var name = $("#person_namesetting_" + pv["hash"]).val();
					$(".person_name_"+ pv["hash"]).text(name);

					// 表示/非表示設定を反映
					var personalId = "person_" + pv["hash"];
					var val = $("#" + personalId + "_temp").prop("checked");
					$("#" + personalId).val(val);
				}

				updateLineDisplay(); // 表示/非表示切り替え
				saveProjectSetting(); // 話者設定保存
			},
			width:"500",
			open: function() {					saveDialoguePos($(this));		},
			resizeStop: function() {		saveDialoguePos($(this));		},
			dragStop: function() {			saveDialoguePos($(this));		},
		});
		$( "#open_peoplelist" ).click(function() {
			$("#peoplelist").dialog("open");
		}); 
		$("#switch_people").on("click", function(){
			$("#peoplelist").dialog( "close" );
		});
		
		// ダイアログ表示中にダイアログ外を押したら閉じる
		$( document ).on( "click", ".ui-widget-overlay", function(){
			$("#help").dialog( "close" );
			$("#peoplelist").dialog( "close" );
		});
		
		// 選択行を適当に決める
		function defaultCurrentTd(){
			if($currentTd){
				return;
			}
			$prevtr = undefined;
			$toptr = undefined;
			$('#table').find('tr').each( function( index, element ){
				var t = $(element).offset().top -  $(window).scrollTop();
				if(t > toptr_top && $prevtr.data('playTd')){
					$toptr = $prevtr; // 画面上最初に表示されているもの
					return false;
				}
				$prevtr = $(element);
			});
			if($toptr){ // 位置調整(進んで戻す)
				$currentTd = $toptr.data('playTd');
				scrollToTop($currentTd, false);
				scrollToBottom($currentTd, false);
			}
		}
		

		// 検索
		var prevSearch = "";
		var searchHit = false;
		var searchHitCount = 0;
		
		function updateSearchResult(){// ヒット件数表示
			if($currentTd && $currentTd.parent() && $currentTd.parent().hasClass("highlight")){
				var count = $currentTd.parent().data("searchhit_count");
				$("#search_result").text(count+"/"+searchHitCount);
			}else if($("#search").val().trim().length > 0){
				$("#search_result").text(searchHitCount);
			}else{
				$("#search_result").text("");
			}
			$(".searchbutton").css("opacity", searchHit ? "1" : "0.5");
		}

		function searchTr(i){ // 特定の行が検索にヒットするかどうかを確認（検索入力更新時か、tr追加時に呼ばれる）
			var search = $("#search").val().trim();
			if(search.length <= 0){
				return;
			}
			
			$tr = $("#tr_" + i);
			if(!$tr.css('display') || $tr.css('display') == "none"){ // 未生成の行+非表示行は対象外とする
				return;
			}
			for(k = textBase; k < data[i].length; k++){
				if(!data[i][k]){
					break;
				}
				if(data[i][k].indexOf(search) >= 0){
					searchHit = true;
					searchHitCount++;
					$tr.addClass("highlight").data("searchhit_count",searchHitCount);
					updateSearchResult();
					return;
				}
			}
		}
		function search(force){ // 全体検索
			var search = $("#search").val().trim();
			if(!force && search == prevSearch){	return;		}

			$(".highlight").removeClass('highlight');
			searchHit = false;
			updateSearchResult();
			if(search.length <= 0){
				return;
			}
			prevSearch = search;
			
			var data = results;
			len = data.length;

			searchHitCount = 0;
			for(i = 0; i < data.length; i++){
				searchTr(i);
			}
		}
		
		// 次の行へ検索(d=1),前の行へ検索(d=-1)
		function nextSearch(d){
			if(!searchHit){				return;			}

			defaultCurrentTd();

			var next_id = $currentTd.data('number');
			$nextPlayTd = null;
			
			do{ // 次の行を探す（非表示の場合はスキップ）
				next_id += d;
				$nextPlayTd = $("#play_" + next_id);
				
				if($nextPlayTd.length <= 0){	return null;} // 最後まで進んだ
				
			}while($nextPlayTd.parent().hasClass("highlight") == false)
			
			// 該当行にフォーカス
			$currentTd = $nextPlayTd;
			changeCurrentTd($currentTd);
			scrollToTop($currentTd, false);
			scrollToBottom($currentTd, false);
			
			// 検索件数表示
			updateSearchResult();
			
		}
		
		// 検索次
		$("#search_next").click(function(){
			nextSearch(1);
		});
		// 検索前
		$("#search_prev").click(function(){
			nextSearch(-1);
		});

		$("#search").keyup(function(){search()});
		$("#search").change(function(){search()});
		
		// キーボード入力
		$(document).on("keydown", function(e) {
			if($("#help").dialog("isOpen")){ // 話者選択ダイアログ表示中
				return true;
			}
			
			if($("#peoplelist").dialog("isOpen")){ // 話者選択ダイアログ表示中
				if(e.key == "ArrowUp" || e.key == "ArrowDown"){ // スクロール抑制
					return false;
				}

				return true;
			}
			
			if(e.code == "F3"){ // 検索
				if(searchHit){ // 次へ検索
					if(e.shiftKey){
						nextSearch(-1);
					}else{
						nextSearch(1);
					}
					$("#search").blur(); 
					return false;
				}else{
					$("#search").focus(); // 検索窓にフォーカス
					return false;
				}
			}
			
			if($("#search").is(":focus")){ // 検索窓で入力中
				if(e.key == "Enter"){ // Enter（次へ）
					if(e.shiftKey){
						nextSearch(-1);
					}else{
						nextSearch(1);
					}

					return false;
				}
				if(e.key == "Escape" ){ // ESC（フォーカス外す）
					$("#search").blur(); 
					return false;
				}

				return true; // 文字入力できるようにtrueを返す
			}
			
			if(e.key == "Enter"){ // Enter
				defaultCurrentTd();
				changeCurrentTd($currentTd);
				return false;
			}

			if(e.key == "Escape"){ // ESC
				$currentTd = undefined;
				changeCurrentTd($currentTd);
				$("#sound")[0].stop();
				return false;
			}
			
			if(e.key == "ArrowUp"){ // ↑（行選択）
				if(e.shiftKey	|| $currentTd){
					defaultCurrentTd();
					
					$td = nextTd($currentTd, -1);
					if($td){
						changeCurrentTd($td);
						scrollToTop($currentTd, false);
					}
					return false;
				}
			}
			if(e.key == "ArrowDown"){ // ↓（行選択）
				if(e.shiftKey	|| $currentTd){
					defaultCurrentTd();
					
					$td = nextTd($currentTd, 1);
					if($td){
						changeCurrentTd($td);
						scrollToBottom($currentTd, false);
					}
					return false;
				}
			}
			
			if(e.key == "ArrowRight"){ // →（候補選択）
				if(e.shiftKey	|| $currentTd){
					defaultCurrentTd();
					changeText($currentTd, 1);
					return false;
				}
			}
			if(e.key == "ArrowLeft"){ // ←（候補選択）
				if(e.shiftKey	|| $currentTd){
					defaultCurrentTd();
					changeText($currentTd, -1);
					return false;
				}
			}
					
			if(e.key == " "){ // スペース（再生/停止）

				if($currentTd){
					if($("#sound").attr("src") != $currentTd.data('filename')){ // 行が変わっていたら再生し直し
						play($currentTd);
					}else{
						if(!$("#sound")[0].paused){// 一時停止/再開
							$("#sound")[0].pause();
						}else{
							$("#sound")[0].play();
						}
					}
					return false;
				}
			}
			
			if(e.code == "KeyC"){ // C,c（コピー）
				if($currentTd){
					copyTdText($currentTd);
					return false;
				}
			}

			
			// 以下、通常のショートカットキーと重複しないように処理（Ctrl+Aなど）
			if(e.ctrlKey){
				return true;
			}
				
			if(e.code == "KeyQ"){ // Q,q（「話者表示」のチェック切り替え）
				$target = $("#showname");
				$target.prop("checked",!$target.prop("checked")).change();
				return false;
			}
			if(e.code == "KeyS"){ // S,s（「認識できなかった行を表示」のチェック切り替え）
				$target = $("#notext");
				$target.prop("checked",!$target.prop("checked")).change();
				return false;
			}
			if(e.code == "KeyT"){ // T,t（「時刻表示」のチェック切り替え）
				$target = $("#abstime");
				$target.prop("checked",!$target.prop("checked")).change();
				return false;
			}
			if(e.code == "KeyA"){ // A,a（連続再生のチェック切り替え）
				$target = $("#autoplay");
				$target.prop("checked",!$target.prop("checked")).change();
				return false;
			}
			if(e.code == "KeyP"){ // P,p（話者設定）
				$("#peoplelist").dialog("open");
				return false;
			}
			if(e.code == "KeyF"){ // F,f（検索窓にフォーカス）
				$("#search").focus();
				return false;
			}
			if(e.code == "KeyH"){ // H,h（ヘルプ）
				$("#help").dialog("open");
				return false;
			}

			
		});
		
		
		// クリップボードにテキストをコピー
		function copyTdText($target){
			changeCurrentTd($target);
			
			$target = $target.parent().data('textTd');
			
			var $clipboard = $('<textarea></textarea>');
			$clipboard.text($target.text());
			$('body').append($clipboard);

			$clipboard.val($target.text());
			$clipboard.select();
			document.execCommand("Copy");
			$clipboard.remove();
		}
		
		// 行追加
		function addTr(data, i){
			var name = data[i][0];
			
			len = data.length;
			
			// 時刻
			t = parseInt(data[i][2])
			$timeTd = $("<td>").addClass("time");

			
			d = getTimeStr(new Date(2000,1,1), t)
			$reltime = $("<span>").addClass("reltime").text(d);
			$timeTd.append($reltime);

			if(typeof baseDate !== "undefined"){ // 時刻情報あり
				d = getTimeStr(baseDate, t);
				$abstime = $("<span>").addClass("abstime").text(d);
				$timeTd.append($abstime);
				
				if($('#abstime').prop('checked')){ // updateTimeModeと同じことをしている（が、ここでupdateTimeModeを呼び出すとガタガタする）
					$reltime.css("display","none");
				}else{
					$abstime.css("display","none");
				}
			}
			
			// 話者
			pv = personalData[name];
			$nameTd = $("<td>").text($("#person_namesetting_"  + pv["hash"]).val()).addClass("name").addClass("person_name_" + pv["hash"]);
			$nameTd.css("display", $('#showname').prop('checked') ? "table-cell" : "none"); // updateShowNameMode と同じことをしている（が、ここでupdateShowNameModeを呼び出すとガタガタする）
			
			// 再生ボタン
			var playTdId = "play_" + i;
			$play = $("<td>").addClass("play").attr({"title": "" }).data('filename',data[i][1]).attr({"id": playTdId }).data('number', i).on("click", function(){
				play($(this));
			});

			// 候補
			var textTdId = "text_" + i;
			$textTd = $("<td>").attr({"id": textTdId }).addClass("text").on("click", function(){ // クリックでコピー
				copyTdText($(this));
			});

			// 左矢印
			$left = $("<td>").attr({"id": textTdId + "_l"}).addClass("button").data('number', i).addClass("prev").on("click", function(){
				changeText($(this), -1);
			});

			// 右矢印
			$right = $("<td>").attr({"id": textTdId + "_r" }).addClass("button").data('number', i).addClass("next").on("click", function(){
				changeText($(this), 1);
			});

			$tr = $("<tr>").addClass("line").attr({"id": "tr_" + i }).data('playTd', $play).data('textTd', $textTd).data('time',t / 1000);

			$tableObj.append(
				$tr
					.append($timeTd) // 時間
					.append($nameTd) // 話者名
					.append($play)
					//.append($("<td>").text(data[i][3]).addClass("score")) // スコア
					//.append($("<td>").attr({"id":"td1_" + i }).text(data[i][1]).hide()) // ファイル名
					.append($left)
					.append($right)
					.append($textTd)
			);

			// 5から先が候補(text<n>に代入
			var k;
			for(k = textBase; k < data[i].length; k++){
				if(!data[i][k]){
					break;
				}
				if(data[i][k].length > 0){
					$textTd.data('text' + (k - textBase), data[i][k]);
				}else{
					break;
				}
			}
			var textlen = k - textBase;
			var current = parseInt(selection[i]); // どの候補を表示するかを設定から読み込む
			if(!current){ current = 0;} // 何か変な文字が入ってたら0にする
			if(current >= textlen){current = 0;} // 外にあふれていても0にする
			
			$textTd.text(data[i][textBase + current]) // 候補を表示
			$textTd.data('textlen', textlen);
			$textTd.data('current', current);

			// ボタンに、いまどの候補を表示しているかを出す
			$left.attr( {"title": (current + 1) + "/" + textlen });
			$right.attr({"title": (current + 1) + "/" + textlen });

			// 認識できたかどうかでクラスを設定
			if(textlen <= 0){
				$tr.addClass("notext");
			}else{
				$tr.addClass("textexists");
			}

			// 話者設定に従って表示非表示を切り替え
			var personalId = "person_" + personalData[name]["hash"];
			$tr.addClass(personalId);
			updatePersonLineDisplay($("#" + personalId));
			
			// 今回追加したtrが検索にヒットするかどうかを再検索
			searchTr(i);
			
			// 次の行へ
			i++;
			if (i < len){
				$('#loading').text("loading... " + Math.ceil(100 * i / len) + "%");
				setTimeout(addTr, 0, data, i); // 非同期の…実装が…ダサい…
			}else{
			//	$('#loading').css("display","none");
				$('#loading').text("complete! 100%");
				var $table = $('table');
				search(true);
			}
			//$("#table").floatThead({ // ヘッダ固定を試したけどしなくてもいいかな
			//	position: 'absolute'
			//});

		}
		
		// localStrageに保存(保存できるサイズの上限はブラウザ依存だが、5MB上限の環境が多いようなので保存できると信じる)
		function saveToLocalStorage(key, value){
			try{
				saveVal = JSON.stringify(value);
				localStorage.setItem("DisNote_" + key, saveVal);
			//	console.log("saveToLocalStorage:" + saveVal);
			}catch (e){
			}
		}
		
		// localStorageから読み込み
		function loadFromLocalStorage(key){
			try{
				return JSON.parse(localStorage.getItem("DisNote_" + key));
			} catch(e){
				return new Object();
			}
		}

		// 設定保存（DisNOTE全体の設定）
		var CONFIG_KEY = "CONFIG";
		function saveConfig(){
			var config = new Object();
			config["showname"] = $("#showname").prop("checked");
			config["notext"] = $("#notext").prop("checked");
			config["abstime"] = $("#abstime").prop("checked");
			config["autoplay"] = $("#autoplay").prop("checked");
			saveToLocalStorage(CONFIG_KEY, config);
		}
		// 設定読み込み（DisNOTE全体の設定）
		function loadConfig(){
			var config = loadFromLocalStorage(CONFIG_KEY);
			if(config){
				if(config.showname){	$("#showname").prop("checked", true);	}
				if(config.notext){	$("#notext").prop("checked", true);	}
				if(config.abstime){	$("#abstime").prop("checked", true);	}
				if(config.autoplay){	$("#autoplay").prop("checked", true);	}
			}else{ // 初期設定
				$("#showname").prop("checked", true);
			}
		}
		
		// 話者設定保存（プロジェクト単位の設定）
		var PROJECT_SETTING_KEY = projectHash + "_SETTING";
		function saveProjectSetting(){
			for (key in personalData){
				var pv = personalData[key];
				
				var personalId = "person_" + pv["hash"]; // 表示/非表示
				pv["show"] = $("#" + personalId).val();
				
				var nameSettingId = "person_namesetting_" + pv["hash"]; // 表示名
				pv["displayname"] = $("#" + nameSettingId).val();
			}
			saveToLocalStorage(PROJECT_SETTING_KEY,personalData);
		}
		// 話者設定読み込み（プロジェクト単位の設定）
		function loadProjectSetting(){
			var setting = loadFromLocalStorage(PROJECT_SETTING_KEY);
			for (key in setting){
				var pv = setting[key];
				
				var personalId = "person_" + pv["hash"]; // 表示/非表示(hiddenとcheckbox両方に反映)
				$("#" + personalId).val(pv["show"]);
				$("#" + personalId + "_temp").prop("checked", (pv["show"] != "false")); 

				var nameSettingId = "person_namesetting_" + pv["hash"]; // 表示名
				$("#" + nameSettingId).val(pv["displayname"]);
			}
		}
		
		// 行ごとの候補選択設定保存（操作のたびに保存すると保存頻度が高くなるので、最後の操作からN秒後に保存するようにする）
		var PROJECT_SELECTION_KEY= projectHash + "_SELECTION";
		var selectionTimeoutId = undefined;
		function saveProjectSelection(){
			if (typeof selectionTimeoutId === 'number') {
				clearTimeout(selectionTimeoutId);
			}
			selectionTimeoutId = setTimeout(saveToLocalStorage, 10 * 1000, PROJECT_SELECTION_KEY,{"selection":selection.join("")});
		}
		// 行ごとの候補選択設定読み込み
		function loadProjectSelection(){
			var s = loadFromLocalStorage(PROJECT_SELECTION_KEY);
			var s2;
			if(s && s["selection"]){
				s2 = s["selection"].split(""); // 文字列で入っているので、1文字ずつの配列にする
			}else{
				s2 = new Array();
			}
			
			for(var i = s2.length; i < data.length; i++){ // 未定義部分に0を詰める
				s2.push("0");
			}
			return s2;
		}
		
		// --- ここからページ読み込み終了時の処理 ---
		var data = results;
		$tableObj = $("#tbody");
		var selection =loadProjectSelection();

		if(typeof baseDate === "undefined"){ // craigの開始時間情報がない場合、時刻表示のcheckbox表示しない
			$("#abstime").prop("disabled", true);
			$("#timelabel").css("display", "none")
		}

		// 話者設定画面の表を作成
		for (key in personalData){
			var pv = personalData[key];
			
			var personalId = "person_" + pv["hash"];
			$input  = $("<input>").prop("type","checkbox").prop("id",personalId + "_temp").prop("checked", true); // checkboxで表示非表示を切り替えるが、画面を閉じるまで反映しない
			$hidden = $("<input>").prop("type","hidden").prop("id",personalId).addClass("person_input").val($input.prop("checked")); // こちらが設定値の本体
			$checkboxTd = $("<td>").append($("<label>").append($input).append($hidden));
			
			$filenameTd = $("<td>").append($("<p>").text(pv["orgfile"]).attr({"title": pv["orgfile"] }).addClass("orgfile"));
			
			var nameSettingId = "person_namesetting_" + pv["hash"];
			$nameTd = $("<td>").append($("<input>").attr("id",nameSettingId).prop("type","input").val(pv["name"])).addClass("name");
			
			$("#peopletable").append($("<tr>").append($checkboxTd).append($filenameTd).append($nameTd));
		}
		
		loadConfig();
		loadProjectSetting();
		updateShowNameMode();
		updateSearchResult();
		updateTimeMode();
		updateLineDisplay();
		
		$("#orgmedia").attr({"src": mixedMediafile });
		if(mixedMediaIsMovie){
			$("#movieThumbnail").attr({"src": mixedMediafile });
			$("#movie").attr({"src": mixedMediafile });
		}else{
			$(".movieThumbnail").css("display", "none")
		}

		// 認識結果行の追加を始める
		addTr(data, 0);

	});

RESULTS

	</script>

</head>
<body>
<div class="container">
	<div class="main">
		<div id="loading" class="loading"></div>
		
		<div id="peoplelist" style="display:none">
			<table id="peopletable">
				<tr>
					<th>表示</th><th>音声ファイル名</th><th>名前</th>
				</tr>

			</table>
			<!-- <input type="button" id="switch_people" value="閉じる"> -->
		</div>
		
		<div id="help" style="display:none">
			<div>
				<span class="caption">通常ショートカット</span>
				<table class="helptable">
					<th>Key</th><th>説明</th></tr>
					<td>Enter</td><td>選択モードON</td></tr>
					<td>H</td>    <td><div class="icon help"></div>この画面を表示</td></tr>
					<td>P</td>    <td><div class="icon people"></div>話者設定</td></tr>
					<td>F,F3</td> <td><div class="icon search"></div>検索</td></tr>
					<td>Q</td>    <td><input type="checkbox" disabled checked>話者表示</td></tr>
					<td>S</td>    <td><input type="checkbox" disabled checked>認識できなかった行を表示</td></tr>
					<td>T</td>    <td><input type="checkbox" disabled checked>時刻表示 <span style="font-size:small">※時刻情報がある場合のみ</span></td></tr>
					<td>A</td>    <td><input type="checkbox" disabled checked>連続再生</td></tr>
				</table>
			</div>

			<div>
				<span class="caption">選択モードON状態のみ</span>
				<table class="helptable">
					<th>Key</th><th>説明</th></tr>
					<td>ESC</td> <td>選択モードOFF</td></tr>
					<td>↑↓</td><td>行選択</td></tr>
					<td>←→</td><td>候補選択</td></tr>
					<td>Space</td><td>再生/停止</td></tr>
					<td>C</td><td>コピー</td></tr>
				</table>
			</div>

		</div>
		
		<div class="header">
			<div id="open_help" class="push icon help" title="説明(H)" ></div>
			<div id="open_peoplelist" class="push icon people" title="話者設定(P)" ></div><div id="peoplecount"></div>
			<div id="search_icon" class="icon search"  ></div>
			<div><input type="text" id="search"></div>
			<div id="search_prev" class="push icon searchbutton"></div>
			<div id="search_next" class="push icon searchbutton"></div>
		</div>
		<span id="search_result" ></span>

		<div class="footer" >
			<table id="foottable">
				<tr>
					<td >
						<audio id="sound" class="sound" src="" controls></audio>
					</td>
					<td class="check">
						<span class="check">
							<label><input type="checkbox" id="showname" ><span>話者表示(Q)</span></label><br>
							<label><input type="checkbox" id="notext"><span>認識できなかった行を表示(S)</span></label><br>
							<label id="timelabel"><input type="checkbox" id="abstime" ><span>時刻表示(T)</span></label>
							<label><input type="checkbox" id="autoplay"><span>連続再生(A)</span></label><br>
						</span>
					</td>
					<td class="orgmedia">
						<audio id="orgmedia" controls></audio>
					</td>
				</tr>
			</table>
		</div>

		<div class="movieThumbnail">
			<video id="movieThumbnail"></video >
		</div>
		<div id="movieDialogue" style="display:none">
			<video id="movie" controls></video >
		</div>

		<table id="table" class="thead main">
			<thead>
				<tr id="head">
					<th >時間</th>
					<th class="name">話者</th>
					<th ></th>
					<th ></th>
					<th ></th>
					<th >候補</th>
				</tr>
			</thead>
			<tbody id="tbody">
			</tbody>

		</table>
		

		
	</div>
</div>
</body>
</html>